{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "f4b7810f-594e-40f3-82c8-dfe10d2f1feb",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Found 4 heuristic algorithms: ['cost_minimizing_greedy_cmg_b900', 'earliest_arrival_first_eaf_4fe1', 'largest_vessel_first_lvf_5e04', 'randomized_sequential_rs_4159']\n",
      "Found 18 test instances: ['100_15_30_T24.txt', '100_15_30_T48.txt', '150_20_40_T24.txt', '150_20_40_T48.txt', '200_20_40_T24.txt', '200_20_40_T48.txt', '250_20_50_T24.txt', '250_20_50_T48.txt', '300_25_60_T24.txt', '300_25_60_T48.txt', '350_25_70_T24.txt', '350_25_70_T48.txt', '400_30_80_T24.txt', '400_30_80_T48.txt', '450_30_80_T24.txt', '450_30_80_T48.txt', '500_40_100_T24.txt', '500_40_100_T48.txt']\n",
      "\n",
      "Starting batch evaluation...\n",
      "================================================================================\n",
      "\n",
      "Testing heuristic: cost_minimizing_greedy_cmg_b900\n",
      "--------------------------------------------------------------------------------\n",
      "  ✓ 100_15_30_T24.txt: objective=66392.77718911621, time=0.38s\n",
      "  ✓ 100_15_30_T48.txt: objective=83719.24311627506, time=0.57s\n",
      "  ✓ 150_20_40_T24.txt: objective=96855.69850157214, time=0.94s\n",
      "  ✓ 150_20_40_T48.txt: objective=120439.3954850854, time=1.62s\n",
      "  ✓ 200_20_40_T24.txt: objective=146548.03467371676, time=1.77s\n",
      "  ✓ 200_20_40_T48.txt: objective=180972.44809321364, time=2.62s\n",
      "  ✓ 250_20_50_T24.txt: objective=189842.69529763586, time=3.40s\n",
      "  ✓ 250_20_50_T48.txt: objective=238299.7840435518, time=5.44s\n",
      "  ✓ 300_25_60_T24.txt: objective=231809.1830432127, time=6.20s\n",
      "  ✓ 300_25_60_T48.txt: objective=292485.6707587438, time=9.48s\n"
     ]
    },
    {
     "ename": "KeyboardInterrupt",
     "evalue": "",
     "output_type": "error",
     "traceback": [
      "\u001b[1;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[1;31mKeyboardInterrupt\u001b[0m                         Traceback (most recent call last)",
      "Cell \u001b[1;32mIn[1], line 90\u001b[0m\n\u001b[0;32m     87\u001b[0m env\u001b[38;5;241m.\u001b[39mreset(output_dir)\n\u001b[0;32m     89\u001b[0m start_time \u001b[38;5;241m=\u001b[39m datetime\u001b[38;5;241m.\u001b[39mnow()\n\u001b[1;32m---> 90\u001b[0m validation_result \u001b[38;5;241m=\u001b[39m hyper_heuristic\u001b[38;5;241m.\u001b[39mrun(env)\n\u001b[0;32m     91\u001b[0m elapsed_time \u001b[38;5;241m=\u001b[39m (datetime\u001b[38;5;241m.\u001b[39mnow() \u001b[38;5;241m-\u001b[39m start_time)\u001b[38;5;241m.\u001b[39mtotal_seconds()\n\u001b[0;32m     93\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m validation_result:\n",
      "File \u001b[1;32m~\\MACE\\MACE-main - 副本\\src\\pipeline\\hyper_heuristics\\single.py:41\u001b[0m, in \u001b[0;36mSingleHyperHeuristic.run\u001b[1;34m(self, env, time_limit, **kwargs)\u001b[0m\n\u001b[0;32m     38\u001b[0m             \u001b[38;5;28mprint\u001b[39m(\u001b[38;5;124mf\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mSolution timeout (\u001b[39m\u001b[38;5;132;01m{\u001b[39;00mtime_limit\u001b[38;5;132;01m}\u001b[39;00m\u001b[38;5;124ms), returning penalty value\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n\u001b[0;32m     39\u001b[0m             \u001b[38;5;28;01mbreak\u001b[39;00m\n\u001b[1;32m---> 41\u001b[0m     _ \u001b[38;5;241m=\u001b[39m env\u001b[38;5;241m.\u001b[39mrun_heuristic(\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mheuristic)\n\u001b[0;32m     42\u001b[0m     current_steps \u001b[38;5;241m+\u001b[39m\u001b[38;5;241m=\u001b[39m \u001b[38;5;241m1\u001b[39m\n\u001b[0;32m     44\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m timeout_occurred:\n",
      "File \u001b[1;32m~\\MACE\\MACE-main - 副本\\src\\problems\\base\\env.py:104\u001b[0m, in \u001b[0;36mBaseEnv.run_heuristic\u001b[1;34m(self, heuristic, parameters, add_record_item)\u001b[0m\n\u001b[0;32m    102\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m \u001b[38;5;21mrun_heuristic\u001b[39m(\u001b[38;5;28mself\u001b[39m, heuristic: \u001b[38;5;28mcallable\u001b[39m, parameters:\u001b[38;5;28mdict\u001b[39m\u001b[38;5;241m=\u001b[39m{}, add_record_item: \u001b[38;5;28mdict\u001b[39m\u001b[38;5;241m=\u001b[39m{}) \u001b[38;5;241m-\u001b[39m\u001b[38;5;241m>\u001b[39m BaseOperator:\n\u001b[0;32m    103\u001b[0m     \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[1;32m--> 104\u001b[0m         operator, delta \u001b[38;5;241m=\u001b[39m heuristic(\n\u001b[0;32m    105\u001b[0m             problem_state\u001b[38;5;241m=\u001b[39m\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mproblem_state,\n\u001b[0;32m    106\u001b[0m             algorithm_data\u001b[38;5;241m=\u001b[39m\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39malgorithm_data,\n\u001b[0;32m    107\u001b[0m             \u001b[38;5;241m*\u001b[39m\u001b[38;5;241m*\u001b[39mparameters\n\u001b[0;32m    108\u001b[0m         )\n\u001b[0;32m    109\u001b[0m         \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(operator, BaseOperator):\n\u001b[0;32m    110\u001b[0m             \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mrun_operator(operator)\n",
      "File \u001b[1;32m<string>:42\u001b[0m, in \u001b[0;36mcost_minimizing_greedy_cmg_b900\u001b[1;34m(problem_state, algorithm_data, **kwargs)\u001b[0m\n",
      "File \u001b[1;32m~\\MACE\\MACE-main - 副本\\src\\problems\\psp\\env.py:551\u001b[0m, in \u001b[0;36mEnv.find_feasible_assignments\u001b[1;34m(self, vessel_id, max_results, solution)\u001b[0m\n\u001b[0;32m    548\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m inbound_tugboats \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[0;32m    549\u001b[0m     \u001b[38;5;28;01mcontinue\u001b[39;00m\n\u001b[1;32m--> 551\u001b[0m outbound_tugboats, _ \u001b[38;5;241m=\u001b[39m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mfind_tugboat_combination(\n\u001b[0;32m    552\u001b[0m     vessel_id, t_out, \u001b[38;5;124m'\u001b[39m\u001b[38;5;124moutbound\u001b[39m\u001b[38;5;124m'\u001b[39m, solution)\n\u001b[0;32m    554\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m outbound_tugboats \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[0;32m    555\u001b[0m     \u001b[38;5;28;01mcontinue\u001b[39;00m\n",
      "File \u001b[1;32m~\\MACE\\MACE-main - 副本\\src\\problems\\psp\\env.py:444\u001b[0m, in \u001b[0;36mEnv.find_tugboat_combination\u001b[1;34m(self, vessel_id, start_time, service_type, solution)\u001b[0m\n\u001b[0;32m    442\u001b[0m available_tugboats \u001b[38;5;241m=\u001b[39m []\n\u001b[0;32m    443\u001b[0m \u001b[38;5;28;01mfor\u001b[39;00m tugboat_id \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mrange\u001b[39m(\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39minstance_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mtugboat_num\u001b[39m\u001b[38;5;124m'\u001b[39m]):\n\u001b[1;32m--> 444\u001b[0m     \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mis_tugboat_available(tugboat_id, start_time, service_duration, prep_time, solution):\n\u001b[0;32m    445\u001b[0m         hp \u001b[38;5;241m=\u001b[39m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39minstance_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mtugboat_horsepower\u001b[39m\u001b[38;5;124m'\u001b[39m][tugboat_id]\n\u001b[0;32m    446\u001b[0m         cost \u001b[38;5;241m=\u001b[39m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39minstance_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mtugboat_costs\u001b[39m\u001b[38;5;124m'\u001b[39m][tugboat_id]\n",
      "File \u001b[1;32m~\\MACE\\MACE-main - 副本\\src\\problems\\psp\\env.py:404\u001b[0m, in \u001b[0;36mEnv.is_tugboat_available\u001b[1;34m(self, tugboat_id, start_time, duration, prep_time, solution)\u001b[0m\n\u001b[0;32m    401\u001b[0m             \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;01mFalse\u001b[39;00m\n\u001b[0;32m    403\u001b[0m \u001b[38;5;66;03m# Check outbound assignments\u001b[39;00m\n\u001b[1;32m--> 404\u001b[0m \u001b[38;5;28;01mfor\u001b[39;00m assigned_tug, assigned_start \u001b[38;5;129;01min\u001b[39;00m solution\u001b[38;5;241m.\u001b[39mtugboat_outbound_assignments\u001b[38;5;241m.\u001b[39mget(vessel_id, []):\n\u001b[0;32m    405\u001b[0m     \u001b[38;5;28;01mif\u001b[39;00m assigned_tug \u001b[38;5;241m==\u001b[39m tugboat_id:\n\u001b[0;32m    406\u001b[0m         assigned_duration \u001b[38;5;241m=\u001b[39m \u001b[38;5;28mint\u001b[39m(\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39minstance_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mvessel_outbound_service_times\u001b[39m\u001b[38;5;124m'\u001b[39m][vessel_id])\n",
      "\u001b[1;31mKeyboardInterrupt\u001b[0m: "
     ]
    }
   ],
   "source": [
    "import os\n",
    "import importlib\n",
    "from datetime import datetime\n",
    "import pandas as pd\n",
    "from src.pipeline.hyper_heuristics.single import SingleHyperHeuristic\n",
    "from src.util.util import search_file\n",
    "\n",
    "\n",
    "problem = \"psp\"\n",
    "heuristic_dir = \"basic_heuristics\"\n",
    "test_data = \"test_data\"\n",
    "result_dir = \"result\"\n",
    "\n",
    "\n",
    "heuristic_pool_path = os.path.join(\"src\", \"problems\", problem, \"heuristics\", heuristic_dir)\n",
    "if not os.path.exists(heuristic_pool_path):\n",
    "    raise FileNotFoundError(f\"Heuristic directory does not exist: {heuristic_pool_path}\")\n",
    "\n",
    "all_heuristics = [\n",
    "    f.replace(\".py\", \"\") for f in os.listdir(heuristic_pool_path)\n",
    "    if f.endswith(\".py\") and f != \"__init__.py\" and not f.startswith(\".\")\n",
    "]\n",
    "\n",
    "print(f\"Found {len(all_heuristics)} heuristic algorithms: {all_heuristics}\")\n",
    "\n",
    "\n",
    "test_data_dir = search_file(\"test_data\", problem)\n",
    "test_data_list = [\n",
    "    f for f in os.listdir(test_data_dir)\n",
    "    if f != \".ipynb_checkpoints\" and not f.startswith(\".\")\n",
    "]\n",
    "\n",
    "print(f\"Found {len(test_data_list)} test instances: {test_data_list}\")\n",
    "\n",
    "\n",
    "try:\n",
    "    module = importlib.import_module(f\"src.problems.{problem}.env\")\n",
    "    Env = getattr(module, \"Env\")\n",
    "except Exception as e:\n",
    "    raise ImportError(f\"Failed to import environment class for problem {problem}: {str(e)}\")\n",
    "\n",
    "\n",
    "base_output_dir = (\n",
    "    os.path.join(os.getenv(\"AMLT_OUTPUT_DIR\"), \"..\", \"..\", \"output\")\n",
    "    if os.getenv(\"AMLT_OUTPUT_DIR\")\n",
    "    else \"output\"\n",
    ")\n",
    "datetime_str = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\n",
    "\n",
    "results_dict = {\n",
    "    \"algorithm\": []\n",
    "}\n",
    "\n",
    "for data_name in test_data_list:\n",
    "    data_ref = data_name.split(\".\")[0]\n",
    "    results_dict[f\"{data_ref}_objective\"] = []\n",
    "    results_dict[f\"{data_ref}_runtime\"] = []\n",
    "\n",
    "\n",
    "print(\"\\nStarting batch evaluation...\")\n",
    "print(\"=\" * 80)\n",
    "\n",
    "for heuristic_name in all_heuristics:\n",
    "    print(f\"\\nTesting heuristic: {heuristic_name}\")\n",
    "    print(\"-\" * 80)\n",
    "\n",
    "    results_dict[\"algorithm\"].append(heuristic_name)\n",
    "\n",
    "    hyper_heuristic = SingleHyperHeuristic(\n",
    "        heuristic=heuristic_name,\n",
    "        problem=problem\n",
    "    )\n",
    "\n",
    "    for data_name in test_data_list:\n",
    "        data_ref = data_name.split(\".\")[0]\n",
    "\n",
    "        try:\n",
    "            env = Env(data_name=data_name)\n",
    "            experiment_name = f\"{heuristic_name}.{datetime_str}\"\n",
    "            output_dir = os.path.join(\n",
    "                base_output_dir,\n",
    "                problem,\n",
    "                result_dir,\n",
    "                env.data_ref_name,\n",
    "                experiment_name\n",
    "            )\n",
    "            env.reset(output_dir)\n",
    "\n",
    "            start_time = datetime.now()\n",
    "            validation_result = hyper_heuristic.run(env)\n",
    "            elapsed_time = (datetime.now() - start_time).total_seconds()\n",
    "\n",
    "            if validation_result:\n",
    "                env.dump_result()\n",
    "                objective_value = env.key_value\n",
    "                results_dict[f\"{data_ref}_objective\"].append(objective_value)\n",
    "                results_dict[f\"{data_ref}_runtime\"].append(f\"{elapsed_time:.2f}s\")\n",
    "                print(f\"  ✓ {data_name}: objective={objective_value}, time={elapsed_time:.2f}s\")\n",
    "            else:\n",
    "                results_dict[f\"{data_ref}_objective\"].append(\"invalid\")\n",
    "                results_dict[f\"{data_ref}_runtime\"].append(\"-\")\n",
    "                print(f\"  ✗ {data_name}: invalid solution\")\n",
    "\n",
    "        except Exception as e:\n",
    "            results_dict[f\"{data_ref}_objective\"].append(\"error\")\n",
    "            results_dict[f\"{data_ref}_runtime\"].append(\"-\")\n",
    "            print(f\"  ✗ {data_name}: error - {str(e)}\")\n",
    "\n",
    "\n",
    "df_results = pd.DataFrame(results_dict)\n",
    "df_results.set_index(\"algorithm\", inplace=True)\n",
    "\n",
    "excel_output_path = os.path.join(\n",
    "    base_output_dir,\n",
    "    problem,\n",
    "    result_dir,\n",
    "    f\"batch_test_results_{datetime_str}.xlsx\"\n",
    ")\n",
    "os.makedirs(os.path.dirname(excel_output_path), exist_ok=True)\n",
    "df_results.to_excel(excel_output_path, engine=\"openpyxl\")\n",
    "\n",
    "print(\"\\n\" + \"=\" * 80)\n",
    "print(f\"Evaluation completed. Results saved to: {excel_output_path}\")\n",
    "print(\"=\" * 80)\n",
    "\n",
    "print(\"\\nResult preview:\")\n",
    "print(df_results)\n",
    "\n",
    "df_results\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3aa0f52b-9f55-49c1-ba50-53fab761f2f6",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.7"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
